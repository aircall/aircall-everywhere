# This workflow will do a clean installation of node dependencies, cache/restore them, build the source code and run tests across different versions of node
# For more information see: https://docs.github.com/en/actions/automating-builds-and-tests/building-and-testing-nodejs

name: Node.js CI

on:
  push:
    branches: ['master']

jobs:
  bootstrap:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-node@v3
        with:
          node-version: '18.x'
          cache: 'npm'
      - uses: actions/cache@v3
        with:
          path: node_modules
          key: aircall-everywhere-node-modules{{ checksum "package.json" }}
      - run: npm ci

  approve:
    runs-on: ubuntu-latest
    needs: bootstrap
    steps:
      - uses: trstringer/manual-approval@v1
        with:
          secret: ${{ secrets.BOT_CREDENTIALS_GITHUB }}
          approvers: litil
          minimum-approvals: 1
          issue-title: 'Deploying to prod from master'
          issue-body: 'Please approve or deny the deployment of the latest version'
          exclude-workflow-initiator-as-approver: false

  npm-publish:
    runs-on: ubuntu-latest
    needs: approve
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-node@v3
        with:
          node-version: '18.x'
          cache: 'npm'
      - uses: actions/cache@v3
        with:
          path: node_modules
          key: aircall-everywhere-node-modules{{ checksum "package.json" }}
      - run: npm run build
      - run: ssh-keyscan -H github.com >> ~/.ssh/known_hosts
      - run: echo "//registry.npmjs.org/:_authToken=$NPM_TOKEN" > ~/aircall-everywhere/.npmrc
      - run: git config --global user.email "guillaume.p.lambert@gmail.com"
      - run: git config --global user.name "Guillaume Lambert"
      - run: npm publish
